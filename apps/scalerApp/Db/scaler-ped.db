
# P   = pedestal PV to write
# R   = not required
# VAL = input raw value used to calculate pedestal
# REF = reference PV, do not calculate pedestal unless this is small
# MIN = minimum value for reference PV
# N   = number of samples in pedestal calculation
 
# e.g.
# P   = fcup_offset
# VAL = scaler.S2
# REF = IPM2C21A
# MIN = 0.1
# N   = 10

record(calcout,"$(P)$(R=)_calcout") {
    field(SCAN,"1 second")
    field(INPA,"$(VAL)")
    field(INPB,"$(REF)")
    field(INPC,"$(MIN)")
    field(CALC,"B<C ? 1 : 0")
    field(OOPT,"When Non-zero")
    field(OCAL,"A")
    field(DOPT,"Use OCAL")
    field(OUT, "$(P)$(R=)_previous PP")
}

record(ai,"$(P)$(R=)_previous") {
    field(FLNK,"$(P)$(R=)_circbuff.PROC PP")
}

record(compress,"$(P)$(R=)_circbuff") {
    field(INP,"$(P)$(R=)_previous")
    field(ALG,"Circular Buffer")
    field(NSAM,"$(N)")
    field(N,"$(N)")
    field(FLNK,"$(P)$(R=)_average.PROC PP")
}

record(compress,"$(P)$(R=)_average") {
    field(INP,"$(P)$(R=)_circbuff")
    field(ALG,"N to 1 Average")
    field(NSAM,1)
    field(N,"$(N)")
    field(FLNK,"$(P)$(R=)_write PP")
}

record(seq,"$(P)$(R=)_write") {
    field(DISV,0)
    field(SDIS,"$(P)$(R=)_enable.VAL")
    field(DOL1,"$(P)$(R=)_average")
    field(LNK1,"$(P) PP")
}

record(bi,"$(P)$(R=)_enable") {
    field(ZNAM,"Disabled")
    field(ONAM,"Enabled")
    field(VAL,"0")
}

