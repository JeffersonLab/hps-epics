

# MAIN INPUTS, GATED TRIGGER RATES
# FLINKED FROM jscalers.db
# FLINKED TO FANOUTs
############################################
record(subArray, "HPSTRIGSC_0_GATED") {
    field(DTYP,"Soft Channel")
    field(INP,"B_SCALERSHPS2_Sl10_Ch0.VAL")
    field(NELM,1)
    field(INDX,0)
    field(FTVL,"DOUBLE")
    field(FLNK,"HPSTRIGSC_0_FAN")
}
record(subArray, "HPSTRIGSC_1_GATED") {
    field(DTYP,"Soft Channel")
    field(INP,"B_SCALERSHPS2_Sl10_Ch1.VAL")
    field(NELM,1)
    field(INDX,0)
    field(FTVL,"DOUBLE")
    field(FLNK,"HPSTRIGSC_1_FAN")
}
record(subArray, "HPSTRIGSC_2_GATED") {
    field(DTYP,"Soft Channel")
    field(INP,"B_SCALERSHPS2_Sl10_Ch2.VAL")
    field(NELM,1)
    field(INDX,0)
    field(FTVL,"DOUBLE")
    field(FLNK,"HPSTRIGSC_2_FAN")
}
record(subArray, "HPSTRIGSC_3_GATED") {
    field(DTYP,"Soft Channel")
    field(INP,"B_SCALERSHPS2_Sl10_Ch3.VAL")
    field(NELM,1)
    field(INDX,0)
    field(FTVL,"DOUBLE")
    field(FLNK,"HPSTRIGSC_3_FAN")
}
record(subArray, "HPSTRIGSC_4_GATED") {
    field(DTYP,"Soft Channel")
    field(INP,"B_SCALERSHPS2_Sl10_Ch4.VAL")
    field(NELM,1)
    field(INDX,0)
    field(FTVL,"DOUBLE")
    field(FLNK,"HPSTRIGSC_4_FAN")
}
record(subArray, "HPSTRIGSC_5_GATED") {
    field(DTYP,"Soft Channel")
    field(INP,"B_SCALERSHPS2_Sl10_Ch5.VAL")
    field(NELM,1)
    field(INDX,0)
    field(FTVL,"DOUBLE")
    field(FLNK,"HPSTRIGSC_5_FAN")
}

# FANOUT FROM MAIN INPUTS:
############################################

record(fanout, "HPSTRIGSC_0_FAN") {
    field(LNK1, "HPSTRIGSC_TOTAL")
    field(LNK2, "HPSTRIGSC_0_FRAC")
    field(LNK3, "HPSTRIGSC_0_PRE")
}
record(fanout, "HPSTRIGSC_1_FAN") {
    field(LNK1, "HPSTRIGSC_TOTAL")
    field(LNK2, "HPSTRIGSC_1_FRAC")
    field(LNK3, "HPSTRIGSC_1_PRE")
}
record(fanout, "HPSTRIGSC_2_FAN") {
    field(LNK1, "HPSTRIGSC_TOTAL")
    field(LNK2, "HPSTRIGSC_2_FRAC")
    field(LNK3, "HPSTRIGSC_2_PRE")
}
record(fanout, "HPSTRIGSC_3_FAN") {
    field(LNK1, "HPSTRIGSC_TOTAL")
    field(LNK2, "HPSTRIGSC_3_FRAC")
    field(LNK3, "HPSTRIGSC_3_PRE")
}
record(fanout, "HPSTRIGSC_4_FAN") {
    field(LNK1, "HPSTRIGSC_TOTAL")
    field(LNK2, "HPSTRIGSC_4_FRAC")
    field(LNK3, "HPSTRIGSC_4_PRE")
}
record(fanout, "HPSTRIGSC_5_FAN") {
    field(LNK1, "HPSTRIGSC_TOTAL")
    field(LNK2, "HPSTRIGSC_5_FRAC")
    field(LNK3, "HPSTRIGSC_5_PRE")
    field(LNK4, "HPSTRIGSC_LIVETIME0")
}

# TOTAL GATED RATED, FLINKED FROM FANOUTs:
############################################
record(calc, "HPSTRIGSC_TOTAL") {
    field(INPA,"HPSTRIGSC_0_GATED")
    field(INPB,"HPSTRIGSC_1_GATED")
    field(INPC,"HPSTRIGSC_2_GATED")
    field(INPD,"HPSTRIGSC_3_GATED")
    field(INPE,"HPSTRIGSC_4_GATED")
    field(INPF,"HPSTRIGSC_5_GATED")
    field(CALC,"A+B+C+D+E+F")
}



# COMPUTE RELATIVE RATES, FLINKED FROM FANOUTs:
############################################
record(calc, "HPSTRIGSC_0_FRAC") {
    field(INPA,"HPSTRIGSC_0_GATED")
    field(INPB,"HPSTRIGSC_TOTAL")
    field(CALC,"B>0 ? 100*A/B : -1")
}
record(calc, "HPSTRIGSC_1_FRAC") {
    field(INPA,"HPSTRIGSC_1_GATED")
    field(INPB,"HPSTRIGSC_TOTAL")
    field(CALC,"B>0 ? 100*A/B : -1")
}
record(calc, "HPSTRIGSC_2_FRAC") {
    field(INPA,"HPSTRIGSC_2_GATED")
    field(INPB,"HPSTRIGSC_TOTAL")
    field(CALC,"B>0 ? 100*A/B : -1")
}
record(calc, "HPSTRIGSC_3_FRAC") {
    field(INPA,"HPSTRIGSC_3_GATED")
    field(INPB,"HPSTRIGSC_TOTAL")
    field(CALC,"B>0 ? 100*A/B : -1")
}
record(calc, "HPSTRIGSC_4_FRAC") {
    field(INPA,"HPSTRIGSC_4_GATED")
    field(INPB,"HPSTRIGSC_TOTAL")
    field(CALC,"B>0 ? 100*A/B : -1")
}
record(calc, "HPSTRIGSC_5_FRAC") {
    field(INPA,"HPSTRIGSC_5_GATED")
    field(INPB,"HPSTRIGSC_TOTAL")
    field(CALC,"B>0 ? 100*A/B : -1")
}



# PRESCALED TRIGGER RATES:
# FLINKS to FANOUTS
############################################
record(calc, "HPSTRIGSC_0_PRE") {
    field(INPA,"HPSTRIGSC_0_GATED")
    field(INPB,"HPSTRIGPRESCALE_0")
    field(CALC,"A/(2^B)")
    field(FLNK,"HPSTRIGSC_0_FAN_PRE")
}
record(calc, "HPSTRIGSC_1_PRE") {
    field(INPA,"HPSTRIGSC_1_GATED")
    field(INPB,"HPSTRIGPRESCALE_1")
    field(CALC,"A/(2^B)")
    field(FLNK,"HPSTRIGSC_1_FAN_PRE")
}
record(calc, "HPSTRIGSC_2_PRE") {
    field(INPA,"HPSTRIGSC_2_GATED")
    field(INPB,"HPSTRIGPRESCALE_2")
    field(CALC,"A/(2^B)")
    field(FLNK,"HPSTRIGSC_2_FAN_PRE")
}
record(calc, "HPSTRIGSC_3_PRE") {
    field(INPA,"HPSTRIGSC_3_GATED")
    field(INPB,"HPSTRIGPRESCALE_3")
    field(CALC,"A/(2^B)")
    field(FLNK,"HPSTRIGSC_3_FAN_PRE")
}
record(calc, "HPSTRIGSC_4_PRE") {
    field(INPA,"HPSTRIGSC_4_GATED")
    field(INPB,"HPSTRIGPRESCALE_4")
    field(CALC,"A/(2^B)")
    field(FLNK,"HPSTRIGSC_4_FAN_PRE")
}
record(calc, "HPSTRIGSC_5_PRE") {
    field(INPA,"HPSTRIGSC_5_GATED")
    field(INPB,"HPSTRIGPRESCALE_5")
    field(CALC,"A/(2^B)")
    field(FLNK,"HPSTRIGSC_5_FAN_PRE")
}


# FANOUT TO PRESCALED TOTAL AND FRACTIONS:
############################################
record(fanout, "HPSTRIGSC_0_FAN_PRE") {
    field(LNK1, "HPSTRIGSC_TOTAL_PRE")
    field(LNK2, "HPSTRIGSC_0_FRAC_PRE")
}
record(fanout, "HPSTRIGSC_1_FAN_PRE") {
    field(LNK1, "HPSTRIGSC_TOTAL_PRE")
    field(LNK2, "HPSTRIGSC_1_FRAC_PRE")
}
record(fanout, "HPSTRIGSC_2_FAN_PRE") {
    field(LNK1, "HPSTRIGSC_TOTAL_PRE")
    field(LNK2, "HPSTRIGSC_2_FRAC_PRE")
}
record(fanout, "HPSTRIGSC_3_FAN_PRE") {
    field(LNK1, "HPSTRIGSC_TOTAL_PRE")
    field(LNK2, "HPSTRIGSC_3_FRAC_PRE")
}
record(fanout, "HPSTRIGSC_4_FAN_PRE") {
    field(LNK1, "HPSTRIGSC_TOTAL_PRE")
    field(LNK2, "HPSTRIGSC_4_FRAC_PRE")
}
record(fanout, "HPSTRIGSC_5_FAN_PRE") {
    field(LNK1, "HPSTRIGSC_TOTAL_PRE")
    field(LNK2, "HPSTRIGSC_5_FRAC_PRE")
}


# TOTAL ABSOLUTE PRESCALED RATES, FLINKED FROM FANOUTS:
############################################
record(calc, "HPSTRIGSC_TOTAL_PRE") {
    field(INPA,"HPSTRIGSC_0_PRE")
    field(INPB,"HPSTRIGSC_1_PRE")
    field(INPC,"HPSTRIGSC_2_PRE")
    field(INPD,"HPSTRIGSC_3_PRE")
    field(INPE,"HPSTRIGSC_4_PRE")
    field(INPF,"HPSTRIGSC_5_PRE")
    field(CALC,"A+B+C+D+E+F")
}


# PRESCALED FRACTIONAL RATES, FLINKED FROM FANOUTs:
############################################
record(calc, "HPSTRIGSC_0_FRAC_PRE") {
    field(INPA,"HPSTRIGSC_0_PRE")
    field(INPB,"HPSTRIGSC_TOTAL_PRE")
    field(CALC,"B>0 ? 100*A/B : -1")
    field(FLNK,"HPSTRIGSC_0_SFRAC_PRE")
}
record(calc, "HPSTRIGSC_1_FRAC_PRE") {
    field(INPA,"HPSTRIGSC_1_PRE")
    field(INPB,"HPSTRIGSC_TOTAL_PRE")
    field(CALC,"B>0 ? 100*A/B : -1")
    field(FLNK,"HPSTRIGSC_1_SFRAC_PRE")
}
record(calc, "HPSTRIGSC_2_FRAC_PRE") {
    field(INPA,"HPSTRIGSC_2_PRE")
    field(INPB,"HPSTRIGSC_TOTAL_PRE")
    field(CALC,"B>0 ? 100*A/B : -1")
    field(FLNK,"HPSTRIGSC_2_SFRAC_PRE")
}
record(calc, "HPSTRIGSC_3_FRAC_PRE") {
    field(INPA,"HPSTRIGSC_3_PRE")
    field(INPB,"HPSTRIGSC_TOTAL_PRE")
    field(CALC,"B>0 ? 100*A/B : -1")
    field(FLNK,"HPSTRIGSC_3_SFRAC_PRE")
}
record(calc, "HPSTRIGSC_4_FRAC_PRE") {
    field(INPA,"HPSTRIGSC_4_PRE")
    field(INPB,"HPSTRIGSC_TOTAL_PRE")
    field(CALC,"B>0 ? 100*A/B : -1")
    field(FLNK,"HPSTRIGSC_4_SFRAC_PRE")
}
record(calc, "HPSTRIGSC_5_FRAC_PRE") {
    field(INPA,"HPSTRIGSC_5_PRE")
    field(INPB,"HPSTRIGSC_TOTAL_PRE")
    field(CALC,"B>0 ? 100*A/B : -1")
    field(FLNK,"HPSTRIGSC_5_SFRAC_PRE")
}


# SMOOTHING ONLY, FLINKED FROM FRACTIONAL PRESCALED RATES:
############################################
record(ai, "HPSTRIGSC_0_SFRAC_PRE") {
    field(INP,"HPSTRIGSC_0_FRAC_PRE")
    field(SMOO,0.6)
}
record(ai, "HPSTRIGSC_1_SFRAC_PRE") {
    field(INP,"HPSTRIGSC_1_FRAC_PRE")
    field(SMOO,0.6)
}
record(ai, "HPSTRIGSC_2_SFRAC_PRE") {
    field(INP,"HPSTRIGSC_2_FRAC_PRE")
    field(SMOO,0.6)
}
record(ai, "HPSTRIGSC_3_SFRAC_PRE") {
    field(INP,"HPSTRIGSC_3_FRAC_PRE")
    field(SMOO,0.6)
}
record(ai, "HPSTRIGSC_4_SFRAC_PRE") {
    field(INP,"HPSTRIGSC_4_FRAC_PRE")
    field(SMOO,0.6)
}
record(ai, "HPSTRIGSC_5_SFRAC_PRE") {
    field(INP,"HPSTRIGSC_5_FRAC_PRE")
    field(SMOO,0.6)
}




# DUMMY:
############################################
record(calc, "HPSTRIGSC_TOTAL_FRAC") {
    field(CALC,"100")
    field(SCAN,"10 second")
}

# PRESCALE FACTORS:
############################################
record(ai, "HPSTRIGPRESCALE_0") {
    field(FLNK,"HPSTRIGSC_0_PRE")
}
record(ai, "HPSTRIGPRESCALE_1") {
    field(FLNK,"HPSTRIGSC_1_PRE")
}
record(ai, "HPSTRIGPRESCALE_2") {
    field(FLNK,"HPSTRIGSC_2_PRE")
}
record(ai, "HPSTRIGPRESCALE_3") {
    field(FLNK,"HPSTRIGSC_3_PRE")
}
record(ai, "HPSTRIGPRESCALE_4") {
    field(FLNK,"HPSTRIGSC_4_PRE")
}
record(ai, "HPSTRIGPRESCALE_5") {
    field(FLNK,"HPSTRIGSC_5_PRE")
}



# UNGATED TRIGGER RATES:
####################################################

record(subArray, "HPSTRIGSC_0") {
    field(DTYP,"Soft Channel")
    field(INP,"B_SCALERSHPS2_Sl10_Ch0.VAL")
    field(NELM,1)
    field(MALM,4)
    field(INDX,3)
    field(FTVL,"DOUBLE")
}
record(subArray, "HPSTRIGSC_1") {
    field(DTYP,"Soft Channel")
    field(INP,"B_SCALERSHPS2_Sl10_Ch1.VAL")
    field(NELM,1)
    field(MALM,4)
    field(INDX,3)
    field(FTVL,"DOUBLE")
}
record(subArray, "HPSTRIGSC_2") {
    field(DTYP,"Soft Channel")
    field(INP,"B_SCALERSHPS2_Sl10_Ch2.VAL")
    field(NELM,1)
    field(MALM,4)
    field(INDX,3)
    field(FTVL,"DOUBLE")
}
record(subArray, "HPSTRIGSC_3") {
    field(DTYP,"Soft Channel")
    field(INP,"B_SCALERSHPS2_Sl10_Ch3.VAL")
    field(NELM,1)
    field(MALM,4)
    field(INDX,3)
    field(FTVL,"DOUBLE")
}
record(subArray, "HPSTRIGSC_4") {
    field(DTYP,"Soft Channel")
    field(INP,"B_SCALERSHPS2_Sl10_Ch4.VAL")
    field(NELM,1)
    field(MALM,4)
    field(INDX,3)
    field(FTVL,"DOUBLE")
}
record(subArray, "HPSTRIGSC_5") {
    field(DTYP,"Soft Channel")
    field(INP,"B_SCALERSHPS2_Sl10_Ch5.VAL")
    field(NELM,1)
    field(MALM,4)
    field(INDX,3)
    field(FTVL,"DOUBLE")
    field(FLNK, "HPSTRIGSC_LIVETIME0")
}


# LIVETIME, FLINKED FROM HPSTRIGSC_5:
############################################
record(calc, "HPSTRIGSC_LIVETIME0") {
    field(INPA,"HPSTRIGSC_5_GATED")
    field(INPB,"HPSTRIGSC_5 PP")
    field(INPC,"HPSTRIGSC_4 PP")
    field(INPD,"HPSTRIGSC_3 PP")
    field(INPE,"HPSTRIGSC_2 PP")
    field(INPF,"HPSTRIGSC_1 PP")
    field(INPG,"HPSTRIGSC_0 PP")
    field(CALC,"B>0 ? 100*A/B : -999")
    field(FLNK,"HPSTRIGSC_LIVETIME")
}
record(ai, "HPSTRIGSC_LIVETIME") {
    field(INP,"HPSTRIGSC_LIVETIME0")
    field(SMOO,0.6)
    field(LOW,50.0)
    field(LOLO,10.0)
    field(LSV,MINOR)
    field(LLSV,MAJOR)
}




############################################
############################################
############################################

record(calc, "HPSBEAMANGX") {
    field(INPA,"IPM2H01.XPOS")
    field(INPB,"IPM2H02.XPOS")
    field(CALC,"ATAN((B-A)/26/1000)*1000")
    field(SCAN,"2 second")
}
record(calc, "HPSBEAMANGY") {
    field(INPA,"IPM2H01.YPOS")
    field(INPB,"IPM2H02.YPOS")
    field(CALC,"ATAN((B-A)/26/1000)*1000")
    field(SCAN,"2 second")
}

