# Database for Harp scan
#
#  Vanik Kakoyan  July 24, 2012
# modif: 15 Sep 2014
# Macro paramters:
#   $(P)        - XPS Controller name (P=T1-7-BOT:)
#   $(R)        - Motor (R=m6)
# (HARP)  -prefix for PV and for the Name of the file to save data
# /gluex/data/HarpScans/ - dir for data saving

##### Harp Scan Parameters ##
record(stringout,"$(HARP):fileName1"){
  field(DTYP,"Soft Channel")
  field(VAL,"/gluex/data/HarpScans/s_1.out")
  field(SCAN, "Passive")
}
record(stringout,"$(HARP):fileName2"){
  field(DTYP,"Soft Channel")
  field(VAL,"/gluex/data/HarpScans/s_2.out")
  field(SCAN, "Passive")
}
record(stringout,"$(HARP):fileName"){
  field(DTYP,"Soft Channel")
  field(VAL,"$(HARP)")
  field(SCAN, "Passive")
}
record(ao,"$(HARP):motionCondit"){
  field(DTYP,"Soft Channel")
#  field(VAL,"0.01")
  field(SCAN, "Passive")
}
record(ao,"$(HARP):motionConditInit"){
  field(DTYP,"Soft Channel")
  field(DOL,"$(P)$(R).MRES")
  field(OUT, "$(HARP):motionCondit")
  field(PINI, "YES")
  field(OMSL,"closed_loop")
  field(SCAN, "Passive")
}
record(ao,"$(HARP):runStatus"){
  field(DTYP,"Soft Channel")
  field(VAL,"0")
  field(SCAN, "Passive")
}
record(ao,"$(HARP):offset"){
  field(DTYP,"Soft Channel")
  field(VAL,"0.2")
  field(SCAN, "Passive")
  field(FLNK, "$(HARP):startPosition")
}
# $(HARP):harpStatus  0-Ready, 1-Go to Start position, 2-Acquiring, 3-Done, 4-Abort
record(ao,"$(HARP):harpStatus"){
  field(DTYP,"Soft Channel")
  field(VAL,"0")
  field(SCAN, "Passive")
}
record(ao,"$(HARP):harpQuality"){
  field(DTYP,"Soft Channel")
  field(VAL,"0")
  field(SCAN, "Passive")
}
record(ao,"$(HARP):homePosition"){
  field(DTYP,"Soft Channel")
  field(PINI, "YES")
  field(VAL,".2")
  field(SCAN, "Passive")
}
record(ao,"$(HARP):startPulse"){
  field(DTYP,"Soft Channel")
  field(PINI, "YES")
  field(VAL,"1.")
  field(SCAN, "Passive")
  field(FLNK, "$(HARP):nSteps")
}
record(ao,"$(HARP):endPulse"){
  field(DTYP,"Soft Channel")
  field(PINI, "YES")
  field(VAL,"1.5")
  field(SCAN, "Passive")
  field(FLNK, "$(HARP):nSteps")
}
record(ao,"$(HARP):step"){
  field(DTYP,"Soft Channel")
  field(PINI, "YES")
  field(VAL,"0.05")
  field(SCAN, "Passive")
  field(FLNK, "$(HARP):nSteps")
}
record(calcout, "$(HARP):nSteps") {
  field(INPA, "$(HARP):startPulse")
  field(INPB, "$(HARP):endPulse")
  field(INPC, "$(HARP):step")
  field(CALC, "A>B?(A-B)/C:(B-A)/C")
  field(SCAN, "Passive")
  field(FLNK, "$(HARP):startPosition")
}
record(calc, "$(HARP):startPosition") {
  field(INPA, "$(HARP):startPulse")
  field(INPB, "$(HARP):endPulse")
  field(INPC, "$(HARP):offset")
  field(INPD, "$(HARP):step")
  field(CALC, "A<B?A-C:A+C")
  field(FLNK, "$(HARP):endPosition")
}
record(calc, "$(HARP):endPosition") {
  field(INPA, "$(HARP):startPulse")
  field(INPB, "$(HARP):endPulse")
  field(INPC, "$(HARP):offset")
  field(INPD, "$(HARP):step")
  field(CALC, "A<B?B+C:B-C")
}
record(ao,"$(HARP):scanSpeed"){
  field(DTYP,"Soft Channel")
  field(PINI, "YES")
  field(VAL,".1")
  field(SCAN, "Passive")
}
record(ao,"$(HARP):homeSpeed"){
  field(DTYP,"Soft Channel")
  field(PINI, "YES")
  field(VAL,"0.5")
  field(SCAN, "Passive")
}
##### Run ##
record(ao,"$(HARP):run"){
  field(DTYP,"Soft Channel")
  field(SCAN, "Passive")
  field(FLNK, "$(HARP):run1")
}
record(ao,"$(HARP):run1"){
  field(DTYP,"Soft Channel")
  field(DOL,"1")
  field(OMSL,"closed_loop")
  field(OUT,"$(HARP):runStatus.VAL PP NMS")
  field(SCAN, "Passive")
  field(FLNK, "$(HARP):run2")
}
record(ao,"$(HARP):run2"){
  field(DTYP,"Soft Channel")
  field(DOL,"1")
  field(OMSL,"closed_loop")
  field(OUT,"$(SCALER):ChannelAdvance PP NMS")
  field(SCAN, "Passive")
  field(FLNK, "$(HARP):run3")
}
record(ao,"$(HARP):run3"){
  field(DTYP,"Soft Channel")
  field(DOL,"1")
  field(OMSL,"closed_loop")
  field(OUT,"$(HARP):harpStatus.VAL PP NMS")
  field(SCAN, "Passive")
  field(FLNK, "$(HARP):min_pr")
}
record(calcout, "$(HARP):min_pr") {
  field(INPA, "$(HARP):startPulse")
  field(INPB, "$(HARP):endPulse")
  field(CALC, "A>B?B:A")
  field(OUT,"$(P)$(R)PCOMinPosition.VAL PP NMS")
  field(SCAN, "Passive")
  field(FLNK, "$(HARP):max_pr")
}
record(calcout, "$(HARP):max_pr") {
  field(INPA, "$(HARP):startPulse")
  field(INPB, "$(HARP):endPulse")
  field(CALC, "A>B?A:B")
  field(OUT,"$(P)$(R)PCOMaxPosition.VAL PP NMS")
  field(SCAN, "Passive")
  field(FLNK, "$(HARP):step_pr")
}
record(ao,"$(HARP):step_pr"){
  field(DTYP,"Soft Channel")
  field(DOL,"$(HARP):step")
  field(OMSL,"closed_loop")
  field(OUT,"$(P)$(R)PCOPositionStep.VAL PP NMS")
  field(SCAN, "Passive")
  field(FLNK, "$(HARP):pulseWidth_pr")
}
record(ao,"$(HARP):pulseWidth_pr"){
  field(DTYP,"Soft Channel")
  field(DOL,"2")
  field(OMSL,"closed_loop")
#  field(OUT,"$(P)$(R)PCOPulseWidth.VAL PP NMS")
  field(SCAN, "Passive")
  field(FLNK, "$(HARP):homeSpeed_pr")
}
record(ao,"$(HARP):homeSpeed_pr"){
  field(DTYP,"Soft Channel")
  field(DOL,"$(HARP):homeSpeed")
  field(OMSL,"closed_loop")
  field(OUT,"$(P)$(R).VELO PP NMS")
  field(SCAN, "Passive")
  field(FLNK, "$(HARP):startPos_pr")
}
record(ao,"$(HARP):startPos_pr"){
  field(DTYP,"Soft Channel")
  field(DOL,"$(HARP):startPosition")
  field(OMSL,"closed_loop")
  field(OUT,"$(P)$(R).VAL PP NMS")
  field(SCAN, "Passive")
  field(FLNK, "$(HARP):disable_pr")
}
record(ao,"$(HARP):disable_pr"){
  field(DTYP,"Soft Channel")
  field(DOL,"1")
  field(OMSL,"closed_loop")
  field(OUT,"$(P)$(R)PCODisable PP NMS")
  field(SCAN, "Passive")
  field(FLNK, "$(HARP):set_pr")
}
record(ao,"$(HARP):set_pr"){
  field(DTYP,"Soft Channel")
  field(DOL,"1")
  field(OMSL,"closed_loop")
  field(OUT,"$(P)$(R)PCOSet PP NMS")
  field(SCAN, "Passive")
}


## start scanning
record(calcout, "$(HARP):harp_at_start") {
  field(INPA, "$(P)$(R).RBV")
  field(INPB, "$(HARP):startPosition")
  field(INPC, "$(P)$(R).DMOV")
  field(INPD, "$(HARP):runStatus")
  field(INPE, "$(HARP):motionCondit")
  field(SCAN, ".2 second")
  field(CALC, "(ABS(A-B)<E)&&(C=1)&&(D=1)?1:0")
  field(OUT, "$(HARP):enable.PROC")
  field(OOPT, "When Non-zero")
}
record(ao,"$(HARP):enable"){
  field(DTYP,"Soft Channel")
  field(DOL,"1")
  field(OMSL,"closed_loop")
  field(OUT,"$(P)$(R)PCOEnable PP NMS")
  field(SCAN, "Passive")
  field(FLNK, "$(HARP):statusAcquir")
}
record(ao,"$(HARP):statusAcquir"){
  field(DTYP,"Soft Channel")
  field(DOL,"2")
  field(OMSL,"closed_loop")
  field(OUT,"$(HARP):harpStatus.VAL PP NMS")
  field(SCAN, "Passive")
  field(FLNK, "$(HARP):scanSpeed_pr")
}
record(ao,"$(HARP):scanSpeed_pr"){
  field(DTYP,"Soft Channel")
  field(DOL,"$(HARP):scanSpeed")
  field(OMSL,"closed_loop")
  field(OUT,"$(P)$(R).VELO PP NMS")
  field(SCAN, "Passive")
  field(FLNK, "$(HARP):endPos")
}
record(ao,"$(HARP):endPos"){
  field(DTYP,"Soft Channel")
  field(DOL,"$(HARP):endPosition")
  field(OMSL,"closed_loop")
  field(OUT,"$(P)$(R).VAL PP NMS")
  field(SCAN, "Passive")
  field(FLNK, "$(HARP):startScaler")
}
record(ao,"$(HARP):startScaler"){
  field(DTYP,"Soft Channel")
  field(DOL,"0")
  field(OMSL,"closed_loop")
#  field(OUT,"$(SCALER):StartAll PP NMS")
  field(OUT,"$(SCALER):EraseStart PP NMS")
  field(SCAN, "Passive")
}

## scanning done

record(calcout, "$(HARP):harp_at_end") {
  field(INPA, "$(P)$(R).RBV")
  field(INPB, "$(HARP):endPosition")
  field(INPC, "$(P)$(R).DMOV")
  field(INPD, "$(HARP):runStatus")
  field(INPE, "$(P)$(R).MRES")
  field(SCAN, ".2 second")
  field(CALC, "(ABS(A-B)<E)&&(C=1)&&(D=1)?1:0")
  field(OUT, "$(HARP):done.PROC")
  field(OOPT, "When Non-zero")
#  field(OOPT, "Transition To Non-zero")
}
record(ao,"$(HARP):done"){
  field(DTYP,"Soft Channel")
  field(DOL,"1")
  field(OMSL,"closed_loop")
  field(OUT,"$(HARP):harpQuality.VAL PP NMS")
  field(SCAN, "Passive")
  field(FLNK, "$(HARP):doneStatus")
}
record(ao,"$(HARP):doneStatus"){
  field(DTYP,"Soft Channel")
  field(DOL,"3")
  field(OMSL,"closed_loop")
  field(OUT,"$(HARP):harpStatus.VAL PP NMS")
  field(SCAN, "Passive")
  field(FLNK, "$(HARP):stopScan")
}
record(ao,"$(HARP):stopScan"){
  field(DTYP,"Soft Channel")
  field(DOL,"0")
  field(OMSL,"closed_loop")
  field(OUT,"$(HARP):runStatus.VAL PP NMS")
  field(SCAN, "Passive")
  field(FLNK, "$(HARP):stopScaler")
}
record(ao,"$(HARP):stopScaler"){
  field(DTYP,"Soft Channel")
  field(DOL,"0")
  field(OMSL,"closed_loop")
  field(OUT,"$(SCALER):StopAll PP NMS")
  field(SCAN, "Passive")
  field(FLNK, "$(HARP):endDisable")
}
record(ao,"$(HARP):endDisable"){
  field(DTYP,"Soft Channel")
  field(DOL,"1")
  field(OMSL,"closed_loop")
  field(OUT,"$(P)$(R)PCODisable PP NMS")
  field(SCAN, "Passive")
  field(FLNK, "$(HARP):homeSpeedEnd")
}
record(ao,"$(HARP):homeSpeedEnd"){
  field(DTYP,"Soft Channel")
  field(DOL,"$(HARP):homeSpeed")
  field(OMSL,"closed_loop")
  field(OUT,"$(P)$(R).VELO PP NMS")
  field(SCAN, "Passive")
  field(FLNK, "$(HARP):goHome")
}
record(ao,"$(HARP):goHome"){
  field(DTYP,"Soft Channel")
  field(DOL,"$(HARP):homePosition")
  field(OMSL,"closed_loop")
  field(OUT,"$(P)$(R).VAL PP NMS")
  field(SCAN, "Passive")
  field(FLNK, "$(HARP):quality")
}

record(calcout, "$(HARP):quality") {
  field(INPA, "$(HARP):harpQuality")
  field(CALC, "(A=1)?1:0")
#  field(OUT, "$(HARP):write.PROC")
  field(OUT, "$(HARP):readScaler.PROC")
  field(OOPT, "When Non-zero")
}
record(waveform,"$(HARP):readScaler") {
    field(DESC, "read scaler")
    field(DTYP,"Soft Channel")
    field(INP,  "$(SCALER):mca1")
    field(NELM, "100")
    field(FTVL, "DOUBLE")
#    field(SCAN, ".2 second")
    field(FLNK, "$(HARP):write1")
}

#

record(aSub,"$(HARP):write1") 
{ 
   field(SCAN, "Passive") 
   field(INAM, "HarpAsubInit")
   field(SNAM, "HarpAsubProcess")
   field(NOA,  "100")
   field(INPA, "$(SCALER):mca1 NPP NMS")
#   field(INPA, "$(HARP):readScaler")
   field(NOB,  "100")
   field(INPB, "$(SCALER):mca1 NPP NMS")
   field(NOC,  "100")
   field(INPC, "$(SCALER):mca1 NPP NMS")
   field(NOD,  "100")
   field(INPD, "$(SCALER):mca1 NPP NMS")
   field(NOE,  "100")
   field(INPE, "$(SCALER):mca1 NPP NMS")
   field(NOF,  "100")
   field(INPF, "$(SCALER):mca1 NPP NMS")
   field(NOG,  "100")
   field(INPG, "$(SCALER):mca1 NPP NMS")
   field(NOH,  "100")
   field(INPH, "$(SCALER):mca1 NPP NMS")
   field(NOI,  "100")
   field(INPI, "$(SCALER):mca1 NPP NMS")
   field(NOJ,  "100")
   field(INPJ, "$(SCALER):mca1 NPP NMS")
   field(NOK,  "100")
   field(INPK, "$(SCALER):mca1 NPP NMS")
   field(NOL,  "100")
   field(INPL, "$(SCALER):mca1 NPP NMS")
   field(NOM,  "100")
   field(INPM, "$(SCALER):mca1 NPP NMS")
   field(NON,  "100")
   field(INPN, "$(SCALER):mca1 NPP NMS")
   field(NOO,  "100")
   field(INPO, "$(SCALER):mca1 NPP NMS")
   field(NOP,  "100")
   field(INPP, "$(SCALER):mca1 NPP NMS")

   field(FTQ,  "STRING")
   field(INPQ, "$(HARP):fileName1")

   field(INPR, "$(HARP):startPulse")
   field(INPS, "$(HARP):endPulse")
   field(INPT, "$(HARP):step")
   field(INPU, "1")
   field(FTU,  "LONG")
   field(FLNK, "$(HARP):write2")
} 
record(aSub,"$(HARP):write2") 
{ 
   field(SCAN, "Passive") 
   field(INAM, "HarpAsubInit")
   field(SNAM, "HarpAsubProcess")
   field(NOA,  "100")
   field(INPA, "$(SCALER):mca1 NPP NMS")
   field(NOB,  "100")
   field(INPB, "$(SCALER):mca1 NPP NMS")
   field(NOC,  "100")
   field(INPC, "$(SCALER):mca1 NPP NMS")
   field(NOD,  "100")
   field(INPD, "$(SCALER):mca1 NPP NMS")
   field(NOE,  "100")
   field(INPE, "$(SCALER):mca1 NPP NMS")
   field(NOF,  "100")
   field(INPF, "$(SCALER):mca1 NPP NMS")
   field(NOG,  "100")
   field(INPG, "$(SCALER):mca1 NPP NMS")
   field(NOH,  "100")
   field(INPH, "$(SCALER):mca1 NPP NMS")
   field(NOI,  "100")
   field(INPI, "$(SCALER):mca1 NPP NMS")
   field(NOJ,  "100")
   field(INPJ, "$(SCALER):mca1 NPP NMS")
   field(NOK,  "100")
   field(INPK, "$(SCALER):mca1 NPP NMS")
   field(NOL,  "100")
   field(INPL, "$(SCALER):mca1 NPP NMS")
   field(NOM,  "100")
   field(INPM, "$(SCALER):mca1 NPP NMS")
   field(NON,  "100")
   field(INPN, "$(SCALER):mca1 NPP NMS")
   field(NOO,  "100")
   field(INPO, "$(SCALER):mca1 NPP NMS")
   field(NOP,  "100")
   field(INPP, "$(SCALER):mca1 NPP NMS")

   field(FTQ,  "STRING")
   field(INPQ, "$(HARP):fileName2")
   field(FTR,  "STRING")
   field(INPR, "$(HARP):fileName")

   field(INPU, "2")
   field(FTU,  "LONG")
   field(FLNK, "$(HARP):write")
}

record(sub,"$(HARP):write") 
{ 
   field(SCAN, "Passive") 
   field(INAM, "HarpSubInit")
   field(SNAM, "HarpSubProcess")
   field(INPA, "16")
   field(INPB, "15")
   field(INPC, "100")
   field(INPD, "$(P)$(R).MRES")
}


## Abort ##
record(ao,"$(HARP):abort"){
  field(DTYP,"Soft Channel")
  field(SCAN, "Passive")
  field(FLNK, "$(HARP):abort1")
}
record(ao,"$(HARP):abort1"){
  field(DTYP,"Soft Channel")
  field(DOL,"0")
  field(OMSL,"closed_loop")
  field(OUT,"$(HARP):harpQuality.VAL PP NMS")
  field(SCAN, "Passive")
  field(FLNK, "$(HARP):abort2")
}
record(ao,"$(HARP):abort2"){
  field(DTYP,"Soft Channel")
  field(DOL,"4")
  field(OMSL,"closed_loop")
  field(OUT,"$(HARP):harpStatus.VAL PP NMS")
  field(SCAN, "Passive")
  field(FLNK, "$(HARP):abort3")
}
record(ao,"$(HARP):abort3"){
  field(DTYP,"Soft Channel")
  field(DOL,"0")
  field(OMSL,"closed_loop")
  field(OUT,"$(P)$(R).SPMG PP NMS")
  field(SCAN, "Passive")
  field(FLNK, "$(HARP):abort4")
}
record(calcout, "$(HARP):abort4") {
  field(INPA, "$(P)$(R).DMOV")
  field(INPB, "$(HARP):harpStatus")
  field(CALC, "(A=1)&&(B=4)?1:0")
  field(SCAN, ".2 second")
  field(OUT, "$(HARP):abort5.PROC")
  field(OOPT, "When Non-zero")
#  field(OOPT, "Transition To Non-zero")
}
record(ao,"$(HARP):abort5"){
  field(DTYP,"Soft Channel")
  field(DOL,"3")
  field(OMSL,"closed_loop")
  field(OUT,"$(P)$(R).SPMG PP NMS")
  field(SCAN, "Passive")
  field(FLNK, "$(HARP):stopScan")
}
