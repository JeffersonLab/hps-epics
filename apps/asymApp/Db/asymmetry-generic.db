#
# asymmetry-generic.db
#
# N. Baltzell, 2018
#
# replicates channel-access flow of asymApp/Db/polarization.db
#
# Required macros:
# P       = arbitrary prefix
# INPLUS  = pvname, instantaneous counts
# INMINUS = pvname, instantaneous counts
# DISABLE = pvname, whether to accumulate
# RESET   = pvname, whether to reset accumulated counts to zero
#

record(calc,"$(P):plus:sum") {
    field(DISV,"1")
    field(SDIS,"$(DISABLE) NPP NMS")
    field(INPA,"$(INPLUS) NPP NMS")
    field(INPB,"$(P):plus:sum NPP NMS")
    field(INPD,"$(RESET) NPP NMS")
    field(CALC,"D ? 0 : A+B")
}
record(calc,"$(P):minus:sum") {
    field(DISV,"1")
    field(SDIS,"$(DISABLE) NPP NMS")
    field(INPA,"$(INMINUS) NPP NMS")
    field(INPB,"$(P):minus:sum NPP NMS")
    field(INPD,"$(RESET).VAL NPP NMS")
    field(CALC,"D ? 0 : A+B")
}
record(calc,"$(P):asy") {
    field(INPA,"$(P):plus:sum NPP NMS")
    field(INPB,"$(P):minus:sum NPP NMS")
    field(CALC,"(A-B) / (A+B+0.00001)")
    field(FLNK,"$(P):asy:error.PROC")
}
record(calc,"$(P):asy:error") {
    field(INPA,"$(P):plus:sum")
    field(INPB,"$(P):minus:sum")
    field(INPC,"$(P):asy")
    field(CALC,"sqrt( (1-C*C) / (A+B+0.00001) )")
}

